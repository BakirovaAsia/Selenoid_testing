name: sr_$(Date:yyyyMMdd)$(Rev:.r)
pr: none
trigger: 
- master

jobs:
- job: SemanticRelease
  pool:
    name: SPK-linux-debug
  steps:
  - checkout: none
<<<<<<< HEAD

  - task: DownloadSecureFile@1
    name: PAT_TFS_github_IES
    displayName: 'Download secure file. PAT for vitacoredo'
    inputs:
      secureFile: 'PAT_TFS_github_IES.txt'

  - task: DownloadSecureFile@1
    name: PAT_TFS_github_IES
    displayName: 'Download secure file. PAT for bakirovaasia'
    inputs:
      secureFile: 'PAT_TFS_github_IES.txt'
=======
>>>>>>> 275978695fcee3ebf948f9eaf674b26e8bc7ef1b
      
  - script: |
      echo  $(Build.SourceBranch)
      echo  $(Build.pullRequest.sourceBranch) 

  - task: InstallSSHKey@0
    displayName: 'Install an SSH key'
    inputs:
      knownHostsEntry: 'github.com'
      sshPublicKey: '$(ssh-BA-GitHub)'
      sshKeySecureFile: 'ssh-BA-GitHub'
    
  - script: ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
    displayName: Install key

  - script: |
      if cd ./Selenoid_testing; 
        then git pull; 
        else git clone https://github.com/BakirovaAsia/Selenoid_testing.git ./Selenoid_testing 
      fi
    displayName: Git clone/pull

  - task: NodeTool@0
    displayName: 'Use Node 14.x'
    inputs:
      versionSpec: 14.x
    
  - script: gh auth login --with-token < $(PAT_TFS.secureFilePath)
    displayName: 'GitHub CLI login'

  - script: |
      cd ./Selenoid_testing
      gh pr merge branch-2 -m
    displayName: PR merge

  - script: |
      cd ./Selenoid_testing
      yarn install
      yarn semantic-release
    env: 
      GH_TOKEN: $(PAT_TFS_github_IES)
    displayName: Release
